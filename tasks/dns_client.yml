---
- name: ansible-nameserver | dns_client | retreive masters ip
  ansible.builtin.setup:
  register: dnsmasterssetup
  delegate_facts: true
  delegate_to: "{{ groups[bind_masters_group][0] }}"

- name: ansible-nameserver | dns_client | add dns reference in resolv.conf
  ansible.builtin.lineinfile:
    path: /etc/systemd/resolved.conf
    regexp: "DNS={{ dnsmasterssetup.ansible_facts.ansible_all_ipv4_addresses | sort | join(' ') }}"
    insertafter: '^#DNS='
    line: "DNS={{ dnsmasterssetup.ansible_facts.ansible_all_ipv4_addresses | sort | join(' ') }}"
    owner: root
    group: root
    mode: '0644'
  become: true

- name: ansible-nameserver | install | restarts systemd-resolved
  ansible.builtin.service:
    name: systemd-resolved
    state: restarted
  changed_when: false
  become: true
